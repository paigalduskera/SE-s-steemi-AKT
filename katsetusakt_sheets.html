<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SE Katsetusakt - Mobiil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0a192f;
            --secondary: #112240;
            --accent: #64ffda;
            --text: #ccd6f6;
            --text-muted: #8892b0;
            --bg: #0a192f;
            --card: #1a2744;
            --border: #233554;
            --success: #51cf66;
            --warning: #ff9f1c;
            --error: #ff6b6b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 6rem;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .app-header {
            background: var(--secondary);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .title {
            color: var(--accent);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .top-info {
            padding: 1rem;
            background: var(--secondary);
            margin: 1rem;
            border-radius: 8px;
        }

        .info-grid {
            display: grid;
            gap: 0.8rem;
        }

        .info-field {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-input {
            padding: 0.7rem;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .info-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .work-type-btns {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .work-type-btn {
            padding: 0.7rem;
            background: var(--primary);
            border: 2px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .work-type-btn.active {
            background: var(--accent);
            color: var(--primary);
            border-color: var(--accent);
            font-weight: 600;
        }

        .status-btns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .sejk-container {
            padding: 0 0.8rem 1rem 0.8rem;
        }

        .sejk-item {
            background: var(--secondary);
            border-radius: 12px;
            margin-bottom: 0.8rem;
            border: 2px solid var(--border);
            overflow: hidden;
            transition: all 0.3s;
        }

        .sejk-item.active {
            border-color: var(--accent);
        }

        .sejk-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .sejk-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .sejk-number {
            width: 40px;
            height: 40px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .sejk-details {
            flex: 1;
            min-width: 0;
        }

        .sejk-name-input {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            padding: 0.3rem 0;
            width: 100%;
        }

        .sejk-name-input:focus {
            outline: 1px solid var(--accent);
            border-radius: 4px;
            padding: 0.3rem 0.5rem;
        }

        .sejk-status {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.2rem;
        }

        .chevron {
            font-size: 1.2rem;
            transition: transform 0.3s;
            color: var(--accent);
        }

        .sejk-item.active .chevron {
            transform: rotate(180deg);
        }

        .sejk-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sejk-item.active .sejk-content {
            max-height: 10000px;
        }

        .sejk-body {
            padding: 0 1rem 1rem 1rem;
        }

        .photo-section {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .photo-btn {
            padding: 0.7rem 1rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .delete-sejk-btn {
            padding: 0.7rem 1rem;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .photo-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--accent);
            cursor: pointer;
        }

        .grupp-accordion {
            background: var(--card);
            border-radius: 8px;
            margin-bottom: 0.8rem;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .grupp-header {
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: var(--card);
        }

        .grupp-accordion.active .grupp-header {
            background: var(--border);
        }

        .grupp-title-input {
            background: transparent;
            border: none;
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            padding: 0.3rem;
        }

        .grupp-title-input:focus {
            outline: 1px solid var(--accent);
            border-radius: 4px;
        }

        .grupp-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 0.8rem;
        }

        .grupp-accordion.active .grupp-body {
            max-height: 5000px;
            padding: 0.8rem;
        }

        .field-section {
            margin-bottom: 0.8rem;
        }

        .section-title {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.25rem;
        }

        .field-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.4rem;
        }

        .field-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.35rem;
        }

        .field-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.3rem;
        }

        .field-item {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .field-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            line-height: 1;
        }

        .field-input {
            padding: 0.5rem 0.1rem;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.8rem;
            text-align: center;
            font-family: 'Courier New', monospace;
            min-height: 34px;
            box-sizing: border-box;
        }

        .field-input.wide {
            text-align: left;
        }

        .field-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.1);
        }

        .add-grupp-btn {
            width: 100%;
            padding: 0.8rem;
            background: transparent;
            border: 2px dashed var(--accent);
            color: var(--accent);
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .delete-grupp-btn {
            width: 100%;
            padding: 0.6rem;
            background: transparent;
            border: 1px solid var(--error);
            color: var(--error);
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 0.8rem;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--secondary);
            padding: 1rem;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
        }

        .btn {
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .fab {
            position: fixed;
            bottom: 6rem;
            right: 1rem;
            width: 56px;
            height: 56px;
            background: var(--accent);
            color: var(--primary);
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(100, 255, 218, 0.4);
            z-index: 100;
        }

        .toast {
            position: fixed;
            bottom: 8rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent);
            color: var(--primary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .photo-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
        }

        .photo-modal.show {
            display: flex;
        }

        .photo-modal img {
            max-width: 95%;
            max-height: 95%;
            border-radius: 8px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--accent);
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .signature-section {
            padding: 1rem;
            background: var(--secondary);
            margin: 1rem;
            border-radius: 8px;
        }

        .signature-canvas {
            width: 100%;
            height: 150px;
            background: var(--primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-controls {
            margin-top: 0.5rem;
        }

        .btn-clear-sig {
            width: 100%;
            padding: 0.6rem;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .notes-section {
            padding: 1rem;
            background: var(--secondary);
            margin: 1rem;
            border-radius: 8px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.8rem;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="title">SE S√ºsteemi Katsetusakt</div>
        <div class="subtitle">Keraplast O√ú | Reg: 12053007</div>
    </div>

    <div class="top-info">
        <div class="info-grid">
            <div class="info-field">
                <label class="info-label">T√∂√∂ Nr</label>
                <input type="text" class="info-input" id="workNumber" placeholder="">
            </div>
            <div class="info-field">
                <label class="info-label">Kuup√§ev</label>
                <input type="text" class="info-input" id="workDate" value="">
            </div>
            <div class="info-field">
                <label class="info-label">Objekt</label>
                <input type="text" class="info-input" id="object" placeholder="">
            </div>
            <div class="info-field">
                <label class="info-label">Aadress</label>
                <input type="text" class="info-input" id="address" placeholder="">
            </div>
            <div class="info-field">
                <label class="info-label">Tellija</label>
                <input type="text" class="info-input" id="client" placeholder="">
            </div>
            <div class="info-field">
                <label class="info-label">Koostas</label>
                <input type="text" class="info-input" id="compiler" placeholder="">
            </div>
        </div>

        <div style="margin-top: 1rem;">
            <label class="info-label">T√∂√∂ liik</label>
            <div class="work-type-btns">
                <button class="work-type-btn" onclick="selectWorkType(this, 'Paigaldus')">Paigaldus</button>
                <button class="work-type-btn active" onclick="selectWorkType(this, 'Hooldus')">Hooldus</button>
                <button class="work-type-btn" onclick="selectWorkType(this, 'Remont')">Remont</button>
                <button class="work-type-btn" onclick="selectWorkType(this, '√úlevaatus')">√úlevaatus</button>
            </div>
        </div>

        <div style="margin-top: 1rem;">
            <label class="info-label">SE S√ºsteem t√∂√∂korras</label>
            <div class="status-btns">
                <button class="work-type-btn active" onclick="selectStatus(this, 'k')">‚úì Korras (k)</button>
                <button class="work-type-btn" onclick="selectStatus(this, 'p')">‚úó Puudus (p)</button>
            </div>
        </div>
    </div>

    <div class="sejk-container" id="sejkContainer">
        <!-- SEJK items will be added here -->
    </div>

    <div class="notes-section">
        <label class="info-label">M√§rkused</label>
        <textarea class="notes-textarea" id="notes" placeholder="T√§iendavad m√§rkused..."></textarea>
    </div>

    <div class="signature-section">
        <label class="info-label" style="margin-bottom: 0.5rem; display: block;">Allkiri</label>
        <canvas id="signatureCanvas" class="signature-canvas"></canvas>
        <div class="signature-controls">
            <button class="btn-clear-sig" onclick="clearSignature()">üóëÔ∏è T√ºhista allkiri</button>
        </div>
        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.8rem;">
            T√∂√∂d on teostatud kokkulepitud mahus ja tingimustel ning Tellijal puuduvad pretensioonid teostatud t√∂√∂de kohta.
        </p>
    </div>

    <button class="fab" onclick="addSejk()">+</button>

    <div class="bottom-bar">
        <button class="btn btn-success" onclick="exportPDF()" style="width: 100%;">üìÑ Genereeri AKT</button>
    </div>

    <div class="toast" id="toast"></div>
    <div class="photo-modal" id="photoModal" onclick="closePhotoModal()">
        <span class="photo-modal-close">&times;</span>
        <img id="modalPhoto" src="">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Set current date
        document.getElementById('workDate').value = new Date().toLocaleDateString('et-EE');

        let sejkCounter = 0;
        let selectedWorkType = 'Hooldus';
        let selectedStatus = 'k';

        // Signature canvas setup
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.strokeStyle = '#64ffda';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            return { x, y };
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const coords = getCoordinates(e);
            lastX = coords.x;
            lastY = coords.y;
        }

        function draw(e) {
            e.preventDefault();
            if (!isDrawing) return;
            
            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
            
            lastX = coords.x;
            lastY = coords.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function getSignatureData() {
            return canvas.toDataURL('image/png');
        }

        function selectWorkType(btn, type) {
            document.querySelectorAll('.work-type-btns .work-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedWorkType = type;
        }

        function selectStatus(btn, status) {
            document.querySelectorAll('.status-btns .work-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedStatus = status;
        }

        function addSejk() {
            sejkCounter++;
            const sejkId = `sejk-${sejkCounter}`;
            
            const sejkHtml = `
                <div class="sejk-item" id="${sejkId}" data-sejk-num="${sejkCounter}">
                    <div class="sejk-header" onclick="toggleSejk('${sejkId}')">
                        <div class="sejk-info">
                            <div class="sejk-number">${sejkCounter}</div>
                            <div class="sejk-details">
                                <input type="text" class="sejk-name-input" value="Sejk ${sejkCounter}" 
                                       onclick="event.stopPropagation()" placeholder="SEJK nimi">
                                <div class="sejk-status">0 gruppi</div>
                            </div>
                        </div>
                        <div class="chevron">‚ñº</div>
                    </div>
                    <div class="sejk-content">
                        <div class="sejk-body">
                            <div class="photo-section">
                                <button class="photo-btn" onclick="addPhoto('${sejkId}')">üì∑ Lisa pilt</button>
                                <button class="delete-sejk-btn" onclick="deleteSejk('${sejkId}')">üóëÔ∏è Kustuta SEJK</button>
                                <input type="file" id="photo-${sejkId}" accept="image/*" onchange="handlePhoto('${sejkId}', event)" multiple>
                                <div id="photos-${sejkId}" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                            </div>
                            <div id="grupp-container-${sejkId}"></div>
                            <button class="add-grupp-btn" onclick="addGrupp('${sejkId}')">+ Lisa grupp</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('sejkContainer').insertAdjacentHTML('beforeend', sejkHtml);
            
            // Auto-open and add first group
            setTimeout(() => {
                document.getElementById(sejkId).classList.add('active');
                addGrupp(sejkId);
            }, 100);
            
            showToast('‚úì SEJK lisatud');
        }

        function toggleSejk(sejkId) {
            const item = document.getElementById(sejkId);
            item.classList.toggle('active');
        }

        function deleteSejk(sejkId) {
            if (confirm('Kas kustutada SEJK koos k√µigi gruppidega?')) {
                document.getElementById(sejkId).remove();
                showToast('‚úì SEJK kustutatud');
            }
        }

        let gruppCounter = 0;

        function addGrupp(sejkId) {
            gruppCounter++;
            const gruppId = `grupp-${gruppCounter}`;
            const container = document.getElementById(`grupp-container-${sejkId}`);
            const gruppNum = container.querySelectorAll('.grupp-accordion').length + 1;
            
            const gruppHtml = `
                <div class="grupp-accordion active" id="${gruppId}">
                    <div class="grupp-header" onclick="toggleGrupp('${gruppId}')">
                        <input type="text" class="grupp-title-input" value="Grupp ${gruppNum} - SE1.${gruppNum}L2" 
                               onclick="event.stopPropagation()" placeholder="Grupp nimi + tsoon">
                        <div>‚ñº</div>
                    </div>
                    <div class="grupp-body">
                        <div class="field-section">
                            <div class="section-title">Seadmed</div>
                            <div class="field-grid-2">
                                <div class="field-item">
                                    <label class="field-label">SEL</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">SEA</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">HOC</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">iMCP</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">MCP</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">OPUS</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">W&R</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                                <div></div>
                            </div>
                        </div>

                        <div class="field-section">
                            <div class="section-title">Test</div>
                            <div class="field-grid-2">
                                <div class="field-item">
                                    <label class="field-label">H√§ire</label>
                                    <input type="text" class="field-input" value="k">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">Taastus</label>
                                    <input type="text" class="field-input" value="k">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">Asend</label>
                                    <input type="text" class="field-input" value="k">
                                </div>
                                <div></div>
                            </div>
                        </div>

                        <div class="field-section">
                            <div class="section-title">Vead</div>
                            <div class="field-grid-2">
                                <div class="field-item">
                                    <label class="field-label">Tsoon</label>
                                    <input type="text" class="field-input" value="k">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">Toide</label>
                                    <input type="text" class="field-input" value="k">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">Akud</label>
                                    <input type="text" class="field-input" value="k">
                                </div>
                                <div></div>
                            </div>
                        </div>

                        <div class="field-section">
                            <div class="section-title">M√µ√µtmine</div>
                            <div class="field-grid-2">
                                <div class="field-item">
                                    <label class="field-label">AC/BAT</label>
                                    <input type="text" class="field-input" value="k">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">Aku</label>
                                    <input type="text" class="field-input" placeholder="">
                                </div>
                            </div>
                        </div>

                        <button class="delete-grupp-btn" onclick="deleteGrupp('${gruppId}', '${sejkId}')">‚úï Kustuta grupp</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', gruppHtml);
            updateSejkStatus(sejkId);
        }

        function toggleGrupp(gruppId) {
            const item = document.getElementById(gruppId);
            item.classList.toggle('active');
        }

        function deleteGrupp(gruppId, sejkId) {
            if (confirm('Kas kustutada grupp?')) {
                document.getElementById(gruppId).remove();
                updateSejkStatus(sejkId);
                showToast('‚úì Grupp kustutatud');
            }
        }

        function updateSejkStatus(sejkId) {
            const container = document.getElementById(`grupp-container-${sejkId}`);
            const gruppCount = container.querySelectorAll('.grupp-accordion').length;
            const statusEl = document.querySelector(`#${sejkId} .sejk-status`);
            statusEl.textContent = `${gruppCount} grupp${gruppCount !== 1 ? 'i' : ''}`;
        }

        function addPhoto(sejkId) {
            document.getElementById(`photo-${sejkId}`).click();
        }

        function handlePhoto(sejkId, event) {
            const files = event.target.files;
            const container = document.getElementById(`photos-${sejkId}`);
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-preview';
                    img.onclick = () => showPhotoModal(e.target.result);
                    container.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        function showPhotoModal(src) {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalPhoto');
            modal.classList.add('show');
            modalImg.src = src;
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('show');
        }

        function getFormData() {
            const sejks = [];
            document.querySelectorAll('.sejk-item').forEach(sejkEl => {
                const sejkNum = sejkEl.dataset.sejkNum;
                const sejkName = sejkEl.querySelector('.sejk-name-input').value;
                const photoContainer = sejkEl.querySelector(`#photos-sejk-${sejkNum}`);
                const photos = photoContainer ? Array.from(photoContainer.querySelectorAll('img')).map(img => img.src) : [];
                
                const grupps = [];
                sejkEl.querySelectorAll('.grupp-accordion').forEach(gruppEl => {
                    const inputs = gruppEl.querySelectorAll('.field-input');
                    grupps.push({
                        name: gruppEl.querySelector('.grupp-title-input').value,
                        sel: inputs[0].value,
                        sea: inputs[1].value,
                        hoc: inputs[2].value,
                        imcp: inputs[3].value,
                        mcp: inputs[4].value,
                        opus: inputs[5].value,
                        wr: inputs[6].value,
                        haire: inputs[7].value,
                        taastus: inputs[8].value,
                        asend: inputs[9].value,
                        vTsoon: inputs[10].value,
                        toide: inputs[11].value,
                        akud: inputs[12].value,
                        acbat: inputs[13].value,
                        aku: inputs[14].value
                    });
                });
                
                sejks.push({
                    num: sejkNum,
                    name: sejkName,
                    photos: photos,
                    grupps: grupps
                });
            });

            return {
                workNumber: document.getElementById('workNumber').value,
                workDate: document.getElementById('workDate').value,
                object: document.getElementById('object').value,
                address: document.getElementById('address').value,
                client: document.getElementById('client').value,
                compiler: document.getElementById('compiler').value,
                workType: selectedWorkType,
                systemStatus: selectedStatus,
                notes: document.getElementById('notes').value,
                signatureImage: getSignatureData(),
                sejks: sejks,
                timestamp: new Date().toISOString()
            };
        }

        let lastSavedRowNumber = null;

        async function saveForm() {
            const data = getFormData();
            
            // Save locally first (with signature and photos)
            localStorage.setItem('katsetusakt_mobile', JSON.stringify(data));
            
            // Prepare data for Sheets (WITHOUT signature and photos to keep size small)
            const sejksForSheet = data.sejks.map(sejk => ({
                num: sejk.num,
                name: sejk.name,
                photoCount: sejk.photos ? sejk.photos.length : 0,
                grupps: sejk.grupps
            }));
            
            const sheetData = {
                workNumber: data.workNumber,
                workDate: data.workDate,
                object: data.object,
                address: data.address,
                client: data.client,
                compiler: data.compiler,
                workType: data.workType,
                systemStatus: data.systemStatus,
                notes: data.notes,
                sejks: sejksForSheet
            };
            
            // Send to Google Sheets
            try {
                const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw_lgIpAfXxeBGCPa0MqqNaXUWXu92YfgFTc-BEaY6WtBtq5_349rf1YgnDqySNXLuBxQ/exec';
                
                showToast('üì§ Saadan Google Sheets\'i...');
                
                const params = new URLSearchParams({
                    action: 'save',
                    data: JSON.stringify(sheetData)
                });
                
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?${params.toString()}`);
                const result = await response.json();
                
                if (result.success) {
                    lastSavedRowNumber = result.rowNumber;
                    showToast('‚úì Salvestatud Sheets\'i! (Rida: ' + lastSavedRowNumber + ')');
                } else {
                    throw new Error(result.message || 'Viga');
                }
            } catch (error) {
                console.error('Google Sheets error:', error);
                showToast('‚ö† Salvestatud ainult lokaalselt');
            }
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const data = getFormData();

            // Save locally first
            localStorage.setItem('katsetusakt_mobile', JSON.stringify(data));

            // Keraplasti colors
            const keraplastRed = [237, 106, 94];
            const keraplastGray = [102, 102, 102];
            
            // Add Keraplast logo (NO gray background rectangle behind it)
            const logoBase64 = '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';
            try {
                doc.addImage('data:image/jpeg;base64,' + logoBase64, 'JPEG', 10, 5, 40, 12);
            } catch (e) {
                console.error('Logo error:', e);
            }

            // Header title (no gray background rectangle)
            doc.setFontSize(14);
            doc.setTextColor(keraplastGray[0], keraplastGray[1], keraplastGray[2]);
            doc.text('SE S√úSTEEMI KATSETUSAKT', 148, 12, { align: 'center' });
            
            // Thin separator line under header
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(10, 20, 287, 20);
            
            doc.setFontSize(8);
            doc.setTextColor(0, 0, 0);
            doc.text(`T√∂√∂ Nr: ${data.workNumber}`, 10, 25);
            doc.text(`Kuup√§ev: ${data.workDate}`, 10, 30);
            doc.text(`T√∂√∂v√µtja: Keraplast O√ú, Reg: 12053007`, 10, 35);
            
            doc.text(`Objekt: ${data.object}`, 100, 25);
            doc.text(`Aadress: ${data.address}`, 100, 30);
            doc.text(`Tellija: ${data.client}`, 100, 35);
            
            doc.text(`Koostas: ${data.compiler}`, 190, 25);
            doc.text(`Kontrollis: Silvar Pippar: 220790`, 190, 30);
            
            doc.text(`T√∂√∂ liik: ${data.workType}`, 10, 45);
            doc.text(`S√ºsteem: ${data.systemStatus}`, 60, 45);
            
            // Add legend
            doc.setFontSize(7);
            doc.text('Korras: K     Puudus: P', 190, 45);
            doc.setFontSize(8);

            const tableData = [];
            data.sejks.forEach(sejk => {
                tableData.push([sejk.num, sejk.name, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', sejk.photos.length > 0 ? `üì∑ ${sejk.photos.length}` : '']);
                sejk.grupps.forEach(grupp => {
                    tableData.push(['', grupp.name, grupp.sel, grupp.sea, grupp.hoc, grupp.imcp, grupp.mcp, grupp.opus, grupp.wr, grupp.haire, grupp.taastus, grupp.asend, grupp.vTsoon, grupp.toide, grupp.akud, grupp.acbat, grupp.aku, '']);
                });
            });

            doc.autoTable({
                startY: 50,
                head: [['#', 'SE juhtimiskeskus / Grupp', 'SEL', 'SEA', 'HOC', 'iMCP', 'MCP', 'OPUS', 'W&R', 'H√§ire', 'Taastus', 'Asend', 'Tsoon', 'Toide', 'Akud', 'AC/BAT', 'Aku', 'Pildid']],
                body: tableData,
                styles: { fontSize: 7, cellPadding: 1 },
                headStyles: { fillColor: keraplastGray, textColor: [255, 255, 255] },
                didParseCell: function(data) {
                    if (data.row.index >= 0 && tableData[data.row.index][0] !== '') {
                        data.cell.styles.fillColor = [255, 240, 240];
                        data.cell.styles.textColor = keraplastGray;
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            let finalY = doc.lastAutoTable.finalY + 10;

            if (data.notes) {
                doc.setFontSize(9);
                doc.text('M√§rkused:', 10, finalY);
                doc.setFontSize(7);
                const splitNotes = doc.splitTextToSize(data.notes, 270);
                doc.text(splitNotes, 10, finalY + 5);
                finalY += splitNotes.length * 4 + 10;
            }

            if (data.signatureImage) {
                if (finalY > 160) {
                    doc.addPage();
                    finalY = 20;
                }
                
                doc.setFontSize(8);
                doc.text('T√∂√∂d on teostatud kokkulepitud mahus ja tingimustel ning Tellijal puuduvad pretensioonid teostatud t√∂√∂de kohta.', 10, finalY);
                finalY += 8;
                
                doc.setFontSize(9);
                doc.text('Allkiri:', 10, finalY);
                finalY += 5;
                
                try {
                    doc.addImage(data.signatureImage, 'PNG', 10, finalY, 60, 20);
                    finalY += 25;
                } catch (e) {
                    console.error('Failed to add signature:', e);
                }
            }

            // Add photos
            const sejksWithPhotos = data.sejks.filter(sejk => sejk.photos && sejk.photos.length > 0);
            if (sejksWithPhotos.length > 0) {
                doc.addPage();
                doc.setFontSize(12);
                doc.text('Fotodokumentatsioon', 10, 15);
                
                let y = 25;
                sejksWithPhotos.forEach(sejk => {
                    if (y > 180) {
                        doc.addPage();
                        y = 15;
                    }
                    
                    doc.setFontSize(9);
                    doc.text(`${sejk.name}:`, 10, y);
                    y += 5;
                    
                    let x = 10;
                    sejk.photos.forEach((photo) => {
                        if (x > 250) {
                            x = 10;
                            y += 45;
                            if (y > 180) {
                                doc.addPage();
                                y = 15;
                            }
                        }
                        
                        try {
                            doc.addImage(photo, 'JPEG', x, y, 40, 40);
                            x += 45;
                        } catch (e) {
                            console.error('Failed to add image:', e);
                        }
                    });
                    
                    y += 45;
                });
            }

            // Generate filename
            const cleanAddress = (data.address || 'aadress').replace(/[\/\\:*?"<>|]/g, '');
            const cleanWorkNumber = (data.workNumber || 't√∂√∂Nr').replace(/[\/\\:*?"<>|]/g, '');
            const dateStr = data.workDate || new Date().toLocaleDateString('et-EE');
            const filename = `${cleanAddress}_${cleanWorkNumber}_${dateStr}.pdf`;

            doc.save(filename);
            showToast('‚úì PDF salvestatud!');
            
            // Send to Google Sheets
            sendToSheets(data, filename);
        }

        async function sendToSheets(data, pdfFilename) {
            try {
                const sheetData = {
                    workNumber: data.workNumber,
                    workDate: data.workDate,
                    object: data.object,
                    address: data.address,
                    client: data.client,
                    compiler: data.compiler,
                    workType: data.workType,
                    systemStatus: data.systemStatus,
                    notes: data.notes || '',
                    sejkCount: data.sejks.length,
                    pdfFilename: pdfFilename
                };
                
                const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw_lgIpAfXxeBGCPa0MqqNaXUWXu92YfgFTc-BEaY6WtBtq5_349rf1YgnDqySNXLuBxQ/exec';
                
                const params = new URLSearchParams({
                    action: 'save',
                    data: JSON.stringify(sheetData)
                });
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?${params.toString()}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('‚úì Andmed salvestatud!');
                } else {
                    console.error('Sheets error:', result.message);
                }
            } catch (error) {
                console.error('Sheets error:', error);
                if (error.name === 'AbortError') {
                    console.log('Retrying Sheets save...');
                    setTimeout(() => sendToSheets(data, pdfFilename), 2000);
                }
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // Add first SEJK on load
        addSejk();
    </script>
</body>
</html>
