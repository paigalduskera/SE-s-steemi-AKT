<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SE Katsetusakt - Mobiil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0a192f;
            --secondary: #112240;
            --accent: #64ffda;
            --text: #ccd6f6;
            --text-muted: #8892b0;
            --bg: #0a192f;
            --card: #1a2744;
            --border: #233554;
            --success: #51cf66;
            --warning: #ff9f1c;
            --error: #ff6b6b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 6rem;
            max-width: 100vw;
            overflow-x: hidden;
        }

        .app-header {
            background: var(--secondary);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .title {
            color: var(--accent);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .top-info {
            padding: 1rem;
            background: var(--secondary);
            margin: 1rem;
            border-radius: 8px;
        }

        .info-grid {
            display: grid;
            gap: 0.8rem;
        }

        .info-field {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-input {
            padding: 0.7rem;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .info-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .work-type-btns {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .work-type-btn {
            padding: 0.7rem;
            background: var(--primary);
            border: 2px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .work-type-btn.active {
            background: var(--accent);
            color: var(--primary);
            border-color: var(--accent);
            font-weight: 600;
        }

        .status-btns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .sejk-container {
            padding: 0 0.8rem 1rem 0.8rem;
        }

        .sejk-item {
            background: var(--secondary);
            border-radius: 12px;
            margin-bottom: 0.8rem;
            border: 2px solid var(--border);
            overflow: hidden;
            transition: all 0.3s;
        }

        .sejk-item.active {
            border-color: var(--accent);
        }

        .sejk-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .sejk-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .sejk-number {
            width: 40px;
            height: 40px;
            background: var(--accent);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .sejk-details {
            flex: 1;
            min-width: 0;
        }

        .sejk-name-input {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            padding: 0.3rem 0;
            width: 100%;
        }

        .sejk-name-input:focus {
            outline: 1px solid var(--accent);
            border-radius: 4px;
            padding: 0.3rem 0.5rem;
        }

        .sejk-status {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.2rem;
        }

        .chevron {
            font-size: 1.2rem;
            transition: transform 0.3s;
            color: var(--accent);
        }

        .sejk-item.active .chevron {
            transform: rotate(180deg);
        }

        .sejk-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sejk-item.active .sejk-content {
            max-height: 10000px;
        }

        .sejk-body {
            padding: 0 1rem 1rem 1rem;
        }

        .photo-section {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .photo-btn {
            padding: 0.7rem 1rem;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .delete-sejk-btn {
            padding: 0.7rem 1rem;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .photo-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--accent);
            cursor: pointer;
        }

        .grupp-accordion {
            background: var(--card);
            border-radius: 8px;
            margin-bottom: 0.8rem;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .grupp-header {
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: var(--card);
        }

        .grupp-accordion.active .grupp-header {
            background: var(--border);
        }

        .grupp-title-input {
            background: transparent;
            border: none;
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            padding: 0.3rem;
        }

        .grupp-title-input:focus {
            outline: 1px solid var(--accent);
            border-radius: 4px;
        }

        .grupp-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 0.8rem;
        }

        .grupp-accordion.active .grupp-body {
            max-height: 5000px;
            padding: 0.8rem;
        }

        .field-section {
            margin-bottom: 0.8rem;
        }

        .section-title {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.25rem;
        }

        .field-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.4rem;
        }

        .field-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.35rem;
        }

        .field-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.3rem;
        }

        .field-item {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .field-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            line-height: 1;
        }

        .field-input {
            padding: 0.5rem 0.1rem;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.8rem;
            text-align: center;
            font-family: 'Courier New', monospace;
            min-height: 34px;
            box-sizing: border-box;
        }

        .field-input.wide {
            text-align: left;
        }

        .field-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.1);
        }

        .add-grupp-btn {
            width: 100%;
            padding: 0.8rem;
            background: transparent;
            border: 2px dashed var(--accent);
            color: var(--accent);
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .delete-grupp-btn {
            width: 100%;
            padding: 0.6rem;
            background: transparent;
            border: 1px solid var(--error);
            color: var(--error);
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 0.8rem;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--secondary);
            padding: 1rem;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
        }

        .btn {
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .fab {
            position: fixed;
            bottom: 6rem;
            right: 1rem;
            width: 56px;
            height: 56px;
            background: var(--accent);
            color: var(--primary);
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(100, 255, 218, 0.4);
            z-index: 100;
        }

        .toast {
            position: fixed;
            bottom: 8rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent);
            color: var(--primary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .photo-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
        }

        .photo-modal.show {
            display: flex;
        }

        .photo-modal img {
            max-width: 95%;
            max-height: 95%;
            border-radius: 8px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--accent);
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .signature-section {
            padding: 1rem;
            background: var(--secondary);
            margin: 1rem;
            border-radius: 8px;
        }

        .signature-canvas {
            width: 100%;
            height: 150px;
            background: var(--primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-controls {
            margin-top: 0.5rem;
        }

        .btn-clear-sig {
            width: 100%;
            padding: 0.6rem;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .notes-section {
            padding: 1rem;
            background: var(--secondary);
            margin: 1rem;
            border-radius: 8px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.8rem;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="title">SE S√ºsteemi Katsetusakt</div>
        <div class="subtitle">Keraplast O√ú | Reg: 12053007</div>
    </div>

    <div class="top-info">
        <div class="info-grid">
            <div class="info-field">
                <label class="info-label">T√∂√∂ Nr</label>
                <input type="text" class="info-input" id="workNumber" placeholder="">
            </div>
            <div class="info-field">
                <label class="info-label">Kuup√§ev</label>
                <input type="text" class="info-input" id="workDate" value="">
            </div>
            <div class="info-field">
                <label class="info-label">Objekt</label>
                <input type="text" class="info-input" id="object" placeholder="">
            </div>
            <div class="info-field">
                <label class="info-label">Aadress</label>
                <input type="text" class="info-input" id="address" placeholder="">
            </div>
            <div class="info-field">
                <label class="info-label">Tellija</label>
                <input type="text" class="info-input" id="client" placeholder="">
            </div>
            <div class="info-field">
                <label class="info-label">Koostas</label>
                <input type="text" class="info-input" id="compiler" placeholder="">
            </div>
        </div>

        <div style="margin-top: 1rem;">
            <label class="info-label">T√∂√∂ liik</label>
            <div class="work-type-btns">
                <button class="work-type-btn" onclick="selectWorkType(this, 'Paigaldus')">Paigaldus</button>
                <button class="work-type-btn active" onclick="selectWorkType(this, 'Hooldus')">Hooldus</button>
                <button class="work-type-btn" onclick="selectWorkType(this, 'Remont')">Remont</button>
                <button class="work-type-btn" onclick="selectWorkType(this, '√úlevaatus')">√úlevaatus</button>
            </div>
        </div>

        <div style="margin-top: 1rem;">
            <label class="info-label">SE S√ºsteem t√∂√∂korras</label>
            <div class="status-btns">
                <button class="work-type-btn active" onclick="selectStatus(this, 'k')">‚úì Korras (k)</button>
                <button class="work-type-btn" onclick="selectStatus(this, 'p')">‚úó Puudus (p)</button>
                <button class="work-type-btn" onclick="selectStatus(this, 'o')">‚óê Osaliselt (o)</button>
            </div>
        </div>
    </div>

    <div class="sejk-container" id="sejkContainer">
        <!-- SEJK items will be added here -->
    </div>

    <div class="notes-section">
        <label class="info-label">M√§rkused</label>
        <textarea class="notes-textarea" id="notes" placeholder="T√§iendavad m√§rkused..."></textarea>
    </div>

    <div class="signature-section">
        <label class="info-label" style="margin-bottom: 0.5rem; display: block;">Allkiri</label>
        <canvas id="signatureCanvas" class="signature-canvas"></canvas>
        <div class="signature-controls">
            <button class="btn-clear-sig" onclick="clearSignature()">üóëÔ∏è T√ºhista allkiri</button>
        </div>
        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.8rem;">
            T√∂√∂d on teostatud kokkulepitud mahus ja tingimustel ning Tellijal puuduvad pretensioonid teostatud t√∂√∂de kohta.
        </p>
    </div>

    <button class="fab" onclick="addSejk()">+</button>

    <div class="bottom-bar">
        <button class="btn btn-primary" onclick="saveForm()">üíæ Salvesta</button>
        <button class="btn btn-success" onclick="exportPDF()">üìÑ PDF</button>
    </div>

    <div class="toast" id="toast"></div>
    <div class="photo-modal" id="photoModal" onclick="closePhotoModal()">
        <span class="photo-modal-close">&times;</span>
        <img id="modalPhoto" src="">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Set current date
        document.getElementById('workDate').value = new Date().toLocaleDateString('et-EE');

        let sejkCounter = 0;
        let selectedWorkType = 'Hooldus';
        let selectedStatus = 'k';

        // Signature canvas setup
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            ctx.strokeStyle = '#64ffda';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            return { x, y };
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const coords = getCoordinates(e);
            lastX = coords.x;
            lastY = coords.y;
        }

        function draw(e) {
            e.preventDefault();
            if (!isDrawing) return;
            
            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
            
            lastX = coords.x;
            lastY = coords.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function getSignatureData() {
            return canvas.toDataURL('image/png');
        }

        function selectWorkType(btn, type) {
            document.querySelectorAll('.work-type-btns .work-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedWorkType = type;
        }

        function selectStatus(btn, status) {
            document.querySelectorAll('.status-btns .work-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedStatus = status;
        }

        function addSejk() {
            sejkCounter++;
            const sejkId = `sejk-${sejkCounter}`;
            
            const sejkHtml = `
                <div class="sejk-item" id="${sejkId}" data-sejk-num="${sejkCounter}">
                    <div class="sejk-header" onclick="toggleSejk('${sejkId}')">
                        <div class="sejk-info">
                            <div class="sejk-number">${sejkCounter}</div>
                            <div class="sejk-details">
                                <input type="text" class="sejk-name-input" value="Sejk ${sejkCounter}" 
                                       onclick="event.stopPropagation()" placeholder="SEJK nimi">
                                <div class="sejk-status">0 gruppi</div>
                            </div>
                        </div>
                        <div class="chevron">‚ñº</div>
                    </div>
                    <div class="sejk-content">
                        <div class="sejk-body">
                            <div class="photo-section">
                                <button class="photo-btn" onclick="addPhoto('${sejkId}')">üì∑ Lisa pilt</button>
                                <button class="delete-sejk-btn" onclick="deleteSejk('${sejkId}')">üóëÔ∏è Kustuta SEJK</button>
                                <input type="file" id="photo-${sejkId}" accept="image/*" onchange="handlePhoto('${sejkId}', event)" multiple>
                                <div id="photos-${sejkId}" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                            </div>
                            <div id="grupp-container-${sejkId}"></div>
                            <button class="add-grupp-btn" onclick="addGrupp('${sejkId}')">+ Lisa grupp</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('sejkContainer').insertAdjacentHTML('beforeend', sejkHtml);
            
            // Auto-open and add first group
            setTimeout(() => {
                document.getElementById(sejkId).classList.add('active');
                addGrupp(sejkId);
            }, 100);
            
            showToast('‚úì SEJK lisatud');
        }

        function toggleSejk(sejkId) {
            const item = document.getElementById(sejkId);
            item.classList.toggle('active');
        }

        function deleteSejk(sejkId) {
            if (confirm('Kas kustutada SEJK koos k√µigi gruppidega?')) {
                document.getElementById(sejkId).remove();
                showToast('‚úì SEJK kustutatud');
            }
        }

        let gruppCounter = 0;

        function addGrupp(sejkId) {
            gruppCounter++;
            const gruppId = `grupp-${gruppCounter}`;
            const container = document.getElementById(`grupp-container-${sejkId}`);
            const gruppNum = container.querySelectorAll('.grupp-accordion').length + 1;
            
            const gruppHtml = `
                <div class="grupp-accordion active" id="${gruppId}">
                    <div class="grupp-header" onclick="toggleGrupp('${gruppId}')">
                        <input type="text" class="grupp-title-input" value="Grupp ${gruppNum} - SE1.${gruppNum}L2" 
                               onclick="event.stopPropagation()" placeholder="Grupp nimi + tsoon">
                        <div>‚ñº</div>
                    </div>
                    <div class="grupp-body">
                        <div class="field-section">
                            <div class="section-title">Seadmed</div>
                            <div class="field-grid-2">
                                <div class="field-item">
                                    <label class="field-label">SEL</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">SEA</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">HOC</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">iMCP</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">MCP</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">OPUS</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">W&R</label>
                                    <input type="number" class="field-input" placeholder="">
                                </div>
                                <div></div>
                            </div>
                        </div>

                        <div class="field-section">
                            <div class="section-title">Test</div>
                            <div class="field-grid-2">
                                <div class="field-item">
                                    <label class="field-label">H√§ire</label>
                                    <input type="text" class="field-input" placeholder="k">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">Taastus</label>
                                    <input type="text" class="field-input" placeholder="k">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">Asend</label>
                                    <input type="text" class="field-input" placeholder="k">
                                </div>
                                <div></div>
                            </div>
                        </div>

                        <div class="field-section">
                            <div class="section-title">Vead</div>
                            <div class="field-grid-2">
                                <div class="field-item">
                                    <label class="field-label">Tsoon</label>
                                    <input type="text" class="field-input" placeholder="k">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">Toide</label>
                                    <input type="text" class="field-input" placeholder="k">
                                </div>
                            </div>
                            <div class="field-grid-2" style="margin-top: 0.4rem;">
                                <div class="field-item">
                                    <label class="field-label">Akud</label>
                                    <input type="text" class="field-input" placeholder="k">
                                </div>
                                <div></div>
                            </div>
                        </div>

                        <div class="field-section">
                            <div class="section-title">M√µ√µtmine</div>
                            <div class="field-grid-2">
                                <div class="field-item">
                                    <label class="field-label">AC/BAT</label>
                                    <input type="text" class="field-input" placeholder="k">
                                </div>
                                <div class="field-item">
                                    <label class="field-label">Aku</label>
                                    <input type="text" class="field-input" placeholder="">
                                </div>
                            </div>
                        </div>

                        <button class="delete-grupp-btn" onclick="deleteGrupp('${gruppId}', '${sejkId}')">‚úï Kustuta grupp</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', gruppHtml);
            updateSejkStatus(sejkId);
        }

        function toggleGrupp(gruppId) {
            const item = document.getElementById(gruppId);
            item.classList.toggle('active');
        }

        function deleteGrupp(gruppId, sejkId) {
            if (confirm('Kas kustutada grupp?')) {
                document.getElementById(gruppId).remove();
                updateSejkStatus(sejkId);
                showToast('‚úì Grupp kustutatud');
            }
        }

        function updateSejkStatus(sejkId) {
            const container = document.getElementById(`grupp-container-${sejkId}`);
            const gruppCount = container.querySelectorAll('.grupp-accordion').length;
            const statusEl = document.querySelector(`#${sejkId} .sejk-status`);
            statusEl.textContent = `${gruppCount} grupp${gruppCount !== 1 ? 'i' : ''}`;
        }

        function addPhoto(sejkId) {
            document.getElementById(`photo-${sejkId}`).click();
        }

        function handlePhoto(sejkId, event) {
            const files = event.target.files;
            const container = document.getElementById(`photos-${sejkId}`);
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-preview';
                    img.onclick = () => showPhotoModal(e.target.result);
                    container.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        function showPhotoModal(src) {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalPhoto');
            modal.classList.add('show');
            modalImg.src = src;
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('show');
        }

        function getFormData() {
            const sejks = [];
            document.querySelectorAll('.sejk-item').forEach(sejkEl => {
                const sejkNum = sejkEl.dataset.sejkNum;
                const sejkName = sejkEl.querySelector('.sejk-name-input').value;
                const photoContainer = sejkEl.querySelector(`#photos-sejk-${sejkNum}`);
                const photos = photoContainer ? Array.from(photoContainer.querySelectorAll('img')).map(img => img.src) : [];
                
                const grupps = [];
                sejkEl.querySelectorAll('.grupp-accordion').forEach(gruppEl => {
                    const inputs = gruppEl.querySelectorAll('.field-input');
                    grupps.push({
                        name: gruppEl.querySelector('.grupp-title-input').value,
                        sel: inputs[0].value,
                        sea: inputs[1].value,
                        hoc: inputs[2].value,
                        imcp: inputs[3].value,
                        mcp: inputs[4].value,
                        opus: inputs[5].value,
                        wr: inputs[6].value,
                        haire: inputs[7].value,
                        taastus: inputs[8].value,
                        asend: inputs[9].value,
                        vTsoon: inputs[10].value,
                        toide: inputs[11].value,
                        akud: inputs[12].value,
                        acbat: inputs[13].value,
                        aku: inputs[14].value
                    });
                });
                
                sejks.push({
                    num: sejkNum,
                    name: sejkName,
                    photos: photos,
                    grupps: grupps
                });
            });

            return {
                workNumber: document.getElementById('workNumber').value,
                workDate: document.getElementById('workDate').value,
                object: document.getElementById('object').value,
                address: document.getElementById('address').value,
                client: document.getElementById('client').value,
                compiler: document.getElementById('compiler').value,
                workType: selectedWorkType,
                systemStatus: selectedStatus,
                notes: document.getElementById('notes').value,
                signatureImage: getSignatureData(),
                sejks: sejks,
                timestamp: new Date().toISOString()
            };
        }

        function saveForm() {
            const data = getFormData();
            localStorage.setItem('katsetusakt_mobile', JSON.stringify(data));
            showToast('‚úì Salvestatud!');
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const data = getFormData();

            doc.setFontSize(14);
            doc.text('SE S√úSTEEMI KATSETUSAKT', 148, 15, { align: 'center' });
            
            doc.setFontSize(8);
            doc.text(`T√∂√∂ Nr: ${data.workNumber}`, 10, 25);
            doc.text(`Kuup√§ev: ${data.workDate}`, 10, 30);
            doc.text(`T√∂√∂v√µtja: Keraplast O√ú, Reg: 12053007`, 10, 35);
            
            doc.text(`Objekt: ${data.object}`, 100, 25);
            doc.text(`Aadress: ${data.address}`, 100, 30);
            doc.text(`Tellija: ${data.client}`, 100, 35);
            
            doc.text(`Koostas: ${data.compiler}`, 190, 25);
            doc.text(`Kontrollis: Silvar Pippar: 220790`, 190, 30);
            
            doc.text(`T√∂√∂ liik: ${data.workType}`, 10, 45);
            doc.text(`S√ºsteem: ${data.systemStatus}`, 60, 45);

            const tableData = [];
            data.sejks.forEach(sejk => {
                tableData.push([sejk.num, sejk.name, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', sejk.photos.length > 0 ? `üì∑ ${sejk.photos.length}` : '']);
                sejk.grupps.forEach(grupp => {
                    tableData.push(['', grupp.name, grupp.sel, grupp.sea, grupp.hoc, grupp.imcp, grupp.mcp, grupp.opus, grupp.wr, grupp.haire, grupp.taastus, grupp.asend, grupp.vTsoon, grupp.toide, grupp.akud, grupp.acbat, grupp.aku, '']);
                });
            });

            doc.autoTable({
                startY: 50,
                head: [['#', 'SE juhtimiskeskus / Grupp', 'SEL', 'SEA', 'HOC', 'iMCP', 'MCP', 'OPUS', 'W&R', 'H√§ire', 'Taastus', 'Asend', 'Tsoon', 'Toide', 'Akud', 'AC/BAT', 'Aku', 'Pildid']],
                body: tableData,
                styles: { fontSize: 7, cellPadding: 1 },
                headStyles: { fillColor: [10, 25, 47] },
                didParseCell: function(data) {
                    if (data.row.index >= 0 && tableData[data.row.index][0] !== '') {
                        data.cell.styles.fillColor = [100, 255, 218];
                        data.cell.styles.textColor = [10, 25, 47];
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            let finalY = doc.lastAutoTable.finalY + 10;

            if (data.notes) {
                doc.setFontSize(9);
                doc.text('M√§rkused:', 10, finalY);
                doc.setFontSize(7);
                const splitNotes = doc.splitTextToSize(data.notes, 270);
                doc.text(splitNotes, 10, finalY + 5);
                finalY += splitNotes.length * 4 + 10;
            }

            if (data.signatureImage) {
                if (finalY > 160) {
                    doc.addPage();
                    finalY = 20;
                }
                
                doc.setFontSize(8);
                doc.text('T√∂√∂d on teostatud kokkulepitud mahus ja tingimustel ning Tellijal puuduvad pretensioonid teostatud t√∂√∂de kohta.', 10, finalY);
                finalY += 8;
                
                doc.setFontSize(9);
                doc.text('Allkiri:', 10, finalY);
                finalY += 5;
                
                try {
                    doc.addImage(data.signatureImage, 'PNG', 10, finalY, 60, 20);
                    finalY += 25;
                } catch (e) {
                    console.error('Failed to add signature:', e);
                }
            }

            // Add photos
            const sejksWithPhotos = data.sejks.filter(sejk => sejk.photos && sejk.photos.length > 0);
            if (sejksWithPhotos.length > 0) {
                doc.addPage();
                doc.setFontSize(12);
                doc.text('Fotodokumentatsioon', 10, 15);
                
                let y = 25;
                sejksWithPhotos.forEach(sejk => {
                    if (y > 180) {
                        doc.addPage();
                        y = 15;
                    }
                    
                    doc.setFontSize(9);
                    doc.text(`${sejk.name}:`, 10, y);
                    y += 5;
                    
                    let x = 10;
                    sejk.photos.forEach((photo) => {
                        if (x > 250) {
                            x = 10;
                            y += 45;
                            if (y > 180) {
                                doc.addPage();
                                y = 15;
                            }
                        }
                        
                        try {
                            doc.addImage(photo, 'JPEG', x, y, 40, 40);
                            x += 45;
                        } catch (e) {
                            console.error('Failed to add image:', e);
                        }
                    });
                    
                    y += 45;
                });
            }

            doc.save(`Katsetusakt_${data.workNumber || 'uus'}_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('‚úì PDF eksporditud!');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // Add first SEJK on load
        addSejk();
    </script>
</body>
</html>